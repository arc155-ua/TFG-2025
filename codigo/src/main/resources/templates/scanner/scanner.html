<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/base}">
<head>
    <title>Escanear Código de Barras - CalorieTracker</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container mt-4">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Escanear Código de Barras</h5>
                        </div>
                        <div class="card-body">
                            <div class="scanner-container">
                                <video id="video" class="scanner-video" playsinline autoplay></video>
                            </div>
                            <div id="status" class="mt-2"></div>
                            <div class="error"></div>
                        </div>
                        <div class="card-footer">
                            <a href="/food/search" class="btn btn-secondary">Volver a Búsqueda</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            background-color: #000;
            overflow: hidden;
        }
        .scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .error {
            color: red;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #status {
            color: #666;
            font-size: 0.9em;
        }
    </style>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                const video = document.getElementById('video');
                const status = document.getElementById('status');
                let stream = null;
                let scanning = false;

                function updateStatus(message) {
                    status.textContent = message;
                }

                async function startScanner() {
                    updateStatus('Iniciando cámara...');
                    
                    try {
                        // Obtener acceso a la cámara
                        stream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                facingMode: 'environment',
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        });

                        // Mostrar el video
                        video.srcObject = stream;
                        await video.play();
                        
                        // Iniciar el escaneo
                        scanning = true;
                        scanCode();
                        updateStatus('Escaneando...');
                    } catch (err) {
                        console.error('Error:', err);
                        updateStatus('Error: ' + err.message);
                        document.querySelector('.error').innerHTML = `
                            <strong>${err.name}</strong><br>${err.message}<br>
                            ¿Está permitido el acceso a la cámara?<br>
                            ¿Estás accediendo desde HTTPS o localhost?
                        `;
                    }
                }

                async function scanCode() {
                    if (!scanning) return;

                    try {
                        // Crear un canvas temporal para capturar el frame
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);

                        // Enviar el frame al servidor para procesamiento
                        const response = await fetch('/scanner/process', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                imageData: canvas.toDataURL('image/jpeg')
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.code) {
                                updateStatus('Código detectado: ' + result.code);
                                stopScanner();
                                window.location.href = `/food/barcode/${result.code}`;
                            }
                        }
                    } catch (err) {
                        console.error('Error al escanear:', err);
                    }
                    
                    if (scanning) {
                        requestAnimationFrame(scanCode);
                    }
                }

                function stopScanner() {
                    scanning = false;
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                    updateStatus('Escáner detenido');
                }

                // Iniciar el escáner cuando se carga la página
                startScanner();

                // Detener el escáner cuando se cierra la página
                window.addEventListener('beforeunload', stopScanner);
            });
        </script>
    </th:block>
</body>
</html> 