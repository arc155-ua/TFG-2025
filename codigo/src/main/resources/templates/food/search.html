<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/base}">
<head>
    <title>Buscar Alimentos - CalorieTracker</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container mt-4">
            <h2 class="mb-4">Buscar Alimentos</h2>

            <div class="card">
                <div class="card-body">
                    <form th:action="@{/food/search/results}" method="get" class="mb-4">
                        <div class="input-group">
                            <input type="text" class="form-control" name="query" placeholder="Buscar alimentos..." required>
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                            <a href="/scanner" class="btn btn-secondary">
                                <i class="bi bi-upc-scan"></i> Escanear
                            </a>
                        </div>
                    </form>

                    <div class="alert alert-info">
                        <h5 class="alert-heading">¿Cómo funciona?</h5>
                        <p class="mb-0">
                            Puedes buscar alimentos por nombre, marca o categoría. La búsqueda se realiza primero en nuestra base de datos local
                            y, si no se encuentran resultados, se buscará en la base de datos de OpenFoodFacts.
                            También puedes escanear el código de barras de un producto para encontrarlo rápidamente.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal del Escáner -->
        <div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="scannerModalLabel">Escanear Código de Barras</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="scanner-container">
                            <video id="video" class="scanner-video" playsinline autoplay></video>
                        </div>
                        <div id="status" class="mt-2"></div>
                        <div class="error"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .scanner-container {
                position: relative;
                width: 100%;
                height: 300px;
                background-color: #000;
                overflow: hidden;
            }
            .scanner-video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .error {
                color: red;
                margin-top: 10px;
                padding: 10px;
                background-color: #fff;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            #status {
                color: #666;
                font-size: 0.9em;
            }
        </style>
    </div>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', function() {
                const video = document.getElementById('video');
                const status = document.getElementById('status');
                const scannerModal = document.getElementById('scannerModal');
                let stream = null;
                let detector = null;
                let scanning = false;

                function updateStatus(message) {
                    status.textContent = message;
                }

                async function startScanner() {
                    updateStatus('Iniciando cámara...');
                    
                    try {
                        // Verificar si el navegador soporta BarcodeDetector
                        if (!('BarcodeDetector' in window)) {
                            throw new Error('Tu navegador no soporta la detección de códigos de barras. Por favor, usa Chrome o Edge.');
                        }

                        // Inicializar el detector
                        detector = new BarcodeDetector({
                            formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39']
                        });

                        // Obtener acceso a la cámara
                        stream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                facingMode: 'environment',
                                width: { ideal: 1280 },
                                height: { ideal: 720 }
                            }
                        });

                        // Mostrar el video
                        video.srcObject = stream;
                        await video.play();
                        
                        // Iniciar el escaneo
                        scanning = true;
                        scanCode();
                        updateStatus('Escaneando...');
                    } catch (err) {
                        console.error('Error:', err);
                        updateStatus('Error: ' + err.message);
                        document.querySelector('.error').innerHTML = `
                            <strong>${err.name}</strong><br>${err.message}<br>
                            ¿Está permitido el acceso a la cámara?<br>
                            ¿Estás accediendo desde HTTPS o localhost?
                        `;
                    }
                }

                async function scanCode() {
                    if (!scanning) return;

                    try {
                        const barcodes = await detector.detect(video);
                        
                        if (barcodes.length > 0) {
                            const code = barcodes[0].rawValue;
                            updateStatus('Código detectado: ' + code);
                            stopScanner();
                            
                            const modal = bootstrap.Modal.getInstance(scannerModal);
                            if (modal) modal.hide();
                            
                            fetch(`/food/barcode/${code}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Alimento no encontrado');
                                    }
                                    return response.json();
                                })
                                .then(food => {
                                    if (food) {
                                        window.location.href = `/food/${food.id}`;
                                    } else {
                                        alert('Alimento no encontrado');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    alert(error.message);
                                });
                        }
                    } catch (err) {
                        console.error('Error al escanear:', err);
                    }
                    
                    if (scanning) {
                        requestAnimationFrame(scanCode);
                    }
                }

                function stopScanner() {
                    scanning = false;
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                    updateStatus('Escáner detenido');
                }

                // Iniciar el escáner cuando se abre el modal
                scannerModal.addEventListener('shown.bs.modal', () => {
                    setTimeout(startScanner, 300);
                });

                // Detener el escáner cuando se cierra el modal
                scannerModal.addEventListener('hidden.bs.modal', stopScanner);
            });
        </script>
    </th:block>
</body>
</html>
